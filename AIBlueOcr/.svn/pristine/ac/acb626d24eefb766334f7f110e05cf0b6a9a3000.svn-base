package com.sht.eduai.segment.seganal.service;


import java.io.IOException;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.BasicResponseHandler;
import org.apache.http.impl.client.HttpClientBuilder;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.sht.common.EDUAIConstant;
import com.sht.eduai.comm.dao.CommonBaseDAO;
import com.sht.eduai.vo.ComResultVO;
import com.sht.util.CommUtils;

import kr.co.stc.core.util.StringUtil;


/**
 * 추천정의 > 추천유형 정의  
 * @author miyoungKim
 *
 */
@Service
public class SegAnalService {

	private Logger logger = LoggerFactory.getLogger(SegAnalService.class);
	
	
	@Autowired
	private CommonBaseDAO commonBaseDAO;
	
	
	public ComResultVO selectClustVarList(Map<String, Object> paramMap) {
		ComResultVO comResultVO = new ComResultVO();
		
		List<Map<String, Object>> list = null;
		
		try {
		
//			if("SQL".equals(paramMap.get("SEG_TYPE"))) {
//				paramMap.put("sql", paramMap.get("SEG_SQL"));
//				list = this.commonBaseDAO.list("CommDAO.selectListBySql", paramMap);
//			} else {
				String tableName = "D_USER";
				if ("IR".equals(paramMap.get("IU_TYPE")))
					tableName = "D_ITEM";
				
				paramMap.put("TABLE_NAME", tableName);
				list = this.commonBaseDAO.list("CommDAO.selectClustVarList", paramMap);
				System.out.println("list : " +  list);
//			}
		
			Map<String, Object> dataMap = new HashMap<String, Object>();
			dataMap.put("list", list);
			dataMap.put("dataCount", list.size());
			
			comResultVO.setCode(EDUAIConstant.HTTP_STATUS_OK);
			comResultVO.setData(dataMap);
		} catch(Exception e) {
			comResultVO.setCode(EDUAIConstant.HTTP_STATUS_FAIL);
			comResultVO.setMsg(e.getMessage());
		}

		return comResultVO;
	}


	/**
	 * 분석실행
	 * @param paramMap
	 * @return
	 * @throws Exception
	 */
	@Transactional
	public ComResultVO execute(Map<String, Object> paramMap)throws Exception{
		
		ComResultVO comResultVO = new ComResultVO();
		Map<String, Object> dataMap = new HashMap<String, Object>();
		
		Map<String, Object> info = (Map<String, Object>) paramMap.get("info");
		List<Map<String, Object>> list = (List<Map<String, Object>>) paramMap.get("list");
		
		String err = "";
		
		logger.debug("list: {}", list);
		String [] vlist = new String[list.size()];
		for(int idx = 0; idx<list.size(); idx++) {
			vlist[idx] = (String) list.get(idx).get("name");
		}
				
		//info.put("SEGDA_ID", 1001);
		// 1. DB update
		if (null == info.get("SEGDA_ID")) {
			info.put("USER_NO", paramMap.get("USER_NO"));
			this.commonBaseDAO.insert("SegDaMstrDAO.insert", info);
		} else {
			info.put("USER_NO", paramMap.get("USER_NO"));
			this.commonBaseDAO.update("SegDaMstrDAO.update", info);
		}
		logger.debug("SEGDA_ID: {}", info.get("SEGDA_ID"));
		
		// 2. 파이썬 분석모듈 
		//---------------------------------------
		
		HttpHeaders responseHeaders = new HttpHeaders();
		responseHeaders.add("Content-Type","application/json; charset=utf-8");
		HttpClient client = HttpClientBuilder.create().build();
		HttpPost httpPost = new HttpPost("http://13.124.210.18:8000/reco");
//		HttpPost httpPost = new HttpPost("http://localhost:8000/reco");
					
		JSONObject jsonObject = new JSONObject();
		jsonObject.put("version", "1.0");
		jsonObject.put("rqtype", 1);
		jsonObject.put("segdaid", info.get("SEGDA_ID"));
		jsonObject.put("iutype", info.get("IU_TYPE"));
		String varlist = Arrays.toString(vlist);
		jsonObject.put("varlist", varlist);
		jsonObject.put("segcnt", info.get("SEG_CNT"));

						
//		System.out.println(jsonObject.toString());
		String a = jsonObject.toString();
		httpPost.setEntity(new StringEntity(a, "UTF-8"));
						
//						
	//-------------------json객체로 넘겨주는 방식-------------------------------
						
								 
		HttpResponse response = null;
		try {
				response = client.execute(httpPost);
			// 
			if (response.getStatusLine().getStatusCode() == 200) {
				ResponseHandler<String> handler = new BasicResponseHandler();
				String body = handler.handleResponse(response);
				ObjectMapper objectMapper = new ObjectMapper();
				JsonNode node = objectMapper.readTree(body);
				System.out.println("response is success : " + response.getStatusLine().getStatusCode());
				System.out.println("json : " + node.toString());
				info.put("NODE", node.toString());
				this.commonBaseDAO.update("SegDaMstrDAO.updatePythonResult",info);
			} else {
				System.out.println("response is error : " + response.getStatusLine().getStatusCode());
				this.commonBaseDAO.update("SegDaMstrDAO.updateResultForTest", info);
			}
		} catch (ClientProtocolException e1) {
			e1.printStackTrace();
			err += e1.toString();
		} catch (IOException e2) {
			e2.printStackTrace();
			err += e2.toString();
		}
				
	//---------------------------------------
		
		// 3. 결과 조회 		
		Map<String, Object> result = (Map<String, Object>) this.commonBaseDAO.selectByPk("SegDaMstrDAO.selectSegDaInfo", info);
	   	if (result == null) {
			comResultVO.setCode(EDUAIConstant.HTTP_STATUS_FAIL);
			comResultVO.setMsg("세그먼트 분석결과가 없습니다.");
			dataMap.put("resultInfo", err);
			comResultVO.setData(dataMap);
			
		} else {
			dataMap.put("resultInfo", result);
			
			comResultVO.setCode(EDUAIConstant.HTTP_STATUS_CREATE_OK);
			comResultVO.setData(dataMap);
		}
		return comResultVO;
	}
	
	/**
	 * 세그먼트 저장 
	 * @param paramMap
	 * @return
	 * @throws Exception
	 */
	@Transactional
	public ComResultVO save(Map<String, Object> paramMap)throws Exception{
		
		ComResultVO comResultVO = new ComResultVO();
		Map<String, Object> dataMap = new HashMap<String, Object>();
		
		Map<String, Object> info = (Map<String, Object>) paramMap.get("info");
		List<Map<String, Object>> list = (List<Map<String, Object>>) paramMap.get("list");
		
		int sucessCnt = 0;
		
		logger.debug("list: {}", list);
		
		Map<String, Object> param = new HashMap<String, Object>();
		param.put("FLD_NM", "세그먼트");
		final Integer FLD_ID = (Integer) this.commonBaseDAO.selectByPk("TypeSegMstrDAO.selectSegmentAnalysisFldId", param);
		if (FLD_ID == null) {
			comResultVO.setCode(EDUAIConstant.HTTP_STATUS_FAIL);
			comResultVO.setMsg("[유형명 : 세그먼트] 유형 폴더를 먼저 생성하십시오.");
			comResultVO.setData(dataMap);
		} else {
		
			param = new HashMap<String, Object>();
			param.put("FLD_ID", FLD_ID);
			int ORDINAL = (int) this.commonBaseDAO.selectByPk("SegMstrDAO.selectMaxOrdinalByFldId", param);		
			for (Map<String, Object> map : list) {
				Map<String, Object> setmentParam = info;
				setmentParam.put("SEG_NM", "세그먼트 " + info.get("SEGDA_ID") + "_" + map.get("SEG_NO"));
				setmentParam.put("SEG_DESC", setmentParam.get("SEG_NM"));
				setmentParam.put("SEG_NO", map.get("SEG_NO"));
				setmentParam.put("FLD_ID", FLD_ID);
				setmentParam.put("ORDINAL", ORDINAL);
				setmentParam.put("USER_NO", paramMap.get("USER_NO"));
				logger.debug("setmentParam: {}", setmentParam);
				ORDINAL++;
				this.commonBaseDAO.insert("SegMstrDAO.insert", setmentParam);
				if (null != setmentParam.get("SEG_ID")) {
					sucessCnt++;
				}
			}
			
			dataMap.put("sucessCnt", sucessCnt);
			comResultVO.setCode(EDUAIConstant.HTTP_STATUS_CREATE_OK);
			comResultVO.setData(dataMap);
		}
		return comResultVO;
	}
	
	
}
